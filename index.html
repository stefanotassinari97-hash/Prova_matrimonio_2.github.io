<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lista Nozze ‚Äî Il Nostro Viaggio</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Jost:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #f7f2ea;
    --warm-white: #fdfaf5;
    --gold: #c9a96e;
    --gold-light: #e8d5b0;
    --gold-dark: #a07840;
    --rose: #c4837a;
    --charcoal: #2c2825;
    --warm-gray: #9a8f84;
    --border: rgba(201,169,110,0.25);
    --locked-bg: #eee8de;
    --locked-text: #c8bdb2;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }

  body {
    background-color: var(--cream);
    color: var(--charcoal);
    font-family: 'Jost', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed; inset: 0;
    background:
      radial-gradient(ellipse at 10% 30%, rgba(196,131,122,0.07) 0%, transparent 55%),
      radial-gradient(ellipse at 90% 70%, rgba(201,169,110,0.09) 0%, transparent 55%);
    pointer-events: none; z-index: 0;
  }

  .top-border {
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--gold), var(--rose), var(--gold), transparent);
    position: relative; z-index: 1;
  }

  header {
    text-align: center;
    padding: 56px 20px 32px;
    position: relative; z-index: 1;
  }

  .header-ornament {
    font-size: 18px; color: var(--gold);
    letter-spacing: 14px; margin-bottom: 18px; opacity: 0.65;
  }

  header h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(2.6rem, 6vw, 4.4rem);
    font-weight: 300; letter-spacing: 0.04em; line-height: 1.05;
  }

  header h1 em { font-style: italic; color: var(--rose); }

  .header-date {
    font-size: 0.7rem; letter-spacing: 0.3em;
    text-transform: uppercase; color: var(--warm-gray); margin-top: 14px;
  }

  .header-subtitle {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.1rem; font-style: italic; color: var(--warm-gray);
    margin-top: 18px; max-width: 460px; margin-inline: auto; line-height: 1.7;
  }

  /* STATUS INDICATOR */
  .sync-status {
    display: inline-flex; align-items: center; gap: 6px;
    margin-top: 14px;
    font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase;
    color: var(--warm-gray);
  }

  .sync-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--locked-bg);
    transition: background 0.4s;
  }

  .sync-dot.online  { background: #7cb87c; }
  .sync-dot.loading { background: var(--gold); animation: blink 1s infinite; }
  .sync-dot.error   { background: var(--rose); }

  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .gift-btn-wrap {
    text-align: center; margin: 28px 0 0;
    position: relative; z-index: 1;
  }

  .gift-btn {
    display: inline-block; padding: 14px 48px;
    background: var(--charcoal); color: var(--cream);
    font-family: 'Jost', sans-serif; font-size: 0.72rem;
    font-weight: 400; letter-spacing: 0.22em; text-transform: uppercase;
    border: none; cursor: pointer; border-radius: 1px;
    transition: background 0.3s, letter-spacing 0.3s;
    position: relative; overflow: hidden;
  }

  .gift-btn::before {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(90deg, transparent, rgba(201,169,110,0.15), transparent);
    transform: translateX(-100%); transition: transform 0.5s;
  }

  .gift-btn:hover::before { transform: translateX(100%); }
  .gift-btn:hover { background: var(--gold-dark); letter-spacing: 0.27em; }
  .gift-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* ROADMAP */
  .roadmap-outer {
    position: relative; z-index: 1;
    overflow-x: auto; overflow-y: visible;
    padding: 0 0 30px;
    scrollbar-width: thin;
    scrollbar-color: var(--gold-light) transparent;
  }

  .roadmap-outer::-webkit-scrollbar { height: 4px; }
  .roadmap-outer::-webkit-scrollbar-track { background: transparent; }
  .roadmap-outer::-webkit-scrollbar-thumb { background: var(--gold-light); border-radius: 4px; }

  .roadmap-inner {
    display: flex;
    align-items: center;
    min-width: max-content;
    padding: 140px 80px 140px;
    position: relative;
  }

  .connector {
    width: 90px; height: 2px;
    background: var(--locked-bg);
    flex-shrink: 0; position: relative;
    transition: background 0.6s;
  }

  .connector.done {
    background: linear-gradient(90deg, var(--rose), var(--gold));
  }

  .connector.partial::before {
    content: '';
    position: absolute; left: 0; top: 0;
    height: 100%; width: var(--fill, 0%);
    background: linear-gradient(90deg, var(--rose), var(--gold));
    transition: width 0.8s ease;
  }

  .milestone {
    display: flex; flex-direction: column;
    align-items: center;
    position: relative; flex-shrink: 0;
  }

  .milestone-circle {
    width: 96px; height: 96px; border-radius: 50%;
    border: 2px solid var(--locked-bg);
    background: var(--warm-white);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative;
    transition: all 0.5s cubic-bezier(0.34, 1.4, 0.64, 1);
    box-shadow: 0 2px 14px rgba(44,40,37,0.05);
    z-index: 2;
  }

  .milestone.unlocked .milestone-circle {
    border-color: var(--gold);
    background: linear-gradient(145deg, #fffcf5, var(--warm-white));
    box-shadow: 0 8px 32px rgba(201,169,110,0.25), 0 0 0 7px rgba(201,169,110,0.08);
  }

  .milestone.next .milestone-circle {
    border-color: var(--rose); border-style: dashed;
    box-shadow: 0 4px 22px rgba(196,131,122,0.18), 0 0 0 5px rgba(196,131,122,0.07);
    animation: pulse-next 2.8s ease-in-out infinite;
  }

  .milestone.locked .milestone-circle { opacity: 0.45; }

  @keyframes pulse-next {
    0%,100% { box-shadow: 0 4px 22px rgba(196,131,122,0.18), 0 0 0 5px rgba(196,131,122,0.07); }
    50%      { box-shadow: 0 4px 30px rgba(196,131,122,0.32), 0 0 0 12px rgba(196,131,122,0.04); }
  }

  .milestone-check {
    position: absolute; top: -3px; right: -3px;
    width: 24px; height: 24px; border-radius: 50%;
    background: var(--gold); color: white; font-size: 11px;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transform: scale(0);
    transition: all 0.45s cubic-bezier(0.34, 1.56, 0.64, 1) 0.15s;
    box-shadow: 0 2px 8px rgba(160,120,64,0.35);
  }

  .milestone.unlocked .milestone-check { opacity: 1; transform: scale(1); }

  .milestone-emoji {
    font-size: 2rem; line-height: 1; user-select: none;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .milestone.locked .milestone-emoji { filter: grayscale(1); font-size: 1.3rem; }
  .milestone.unlocked .milestone-circle:hover .milestone-emoji { transform: scale(1.18) rotate(-8deg); }

  .milestone-num {
    font-size: 0.54rem; letter-spacing: 0.18em;
    text-transform: uppercase; color: var(--warm-gray); margin-top: 5px;
  }

  .milestone.locked .milestone-num { color: var(--locked-text); }

  .milestone-stem { width: 1px; background: var(--border); flex-shrink: 0; }

  .milestone-label { width: 130px; text-align: center; flex-shrink: 0; }

  .milestone-name {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.95rem; font-weight: 400;
    color: var(--charcoal); line-height: 1.25; margin-bottom: 4px;
  }

  .milestone.locked .milestone-name { color: var(--locked-text); }

  .milestone-desc {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.72rem; font-style: italic;
    color: var(--warm-gray); line-height: 1.4;
  }

  .milestone.locked .milestone-desc { opacity: 0; }

  .scroll-hint {
    text-align: center; margin: 6px 0 50px;
    font-size: 0.66rem; letter-spacing: 0.2em;
    text-transform: uppercase; color: var(--warm-gray); opacity: 0;
    position: relative; z-index: 1;
    animation: show-hint 4s ease 0.5s forwards;
  }

  @keyframes show-hint {
    0%   { opacity: 0; }
    20%  { opacity: 0.55; }
    80%  { opacity: 0.55; }
    100% { opacity: 0; }
  }

  /* MODALS */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(44,40,37,0.65);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
  }

  .modal-overlay.active { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--warm-white);
    max-width: 460px; width: 100%;
    border-radius: 2px; padding: 48px 44px 40px;
    position: relative;
    transform: translateY(18px) scale(0.97);
    transition: transform 0.35s cubic-bezier(0.34, 1.2, 0.64, 1);
    border: 1px solid var(--border); text-align: center;
  }

  .modal::before {
    content: '';
    position: absolute; top: 0; left: 40px; right: 40px; height: 1px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
  }

  .modal-overlay.active .modal { transform: translateY(0) scale(1); }

  .modal-close {
    position: absolute; top: 14px; right: 18px;
    background: none; border: none;
    font-size: 1.4rem; color: var(--warm-gray);
    cursor: pointer; transition: color 0.2s; line-height: 1;
  }
  .modal-close:hover { color: var(--charcoal); }

  .modal-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2rem; font-weight: 300; margin-bottom: 8px; color: var(--charcoal);
  }

  .modal-sub {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem; font-style: italic; color: var(--warm-gray); margin-bottom: 28px;
  }

  .amount-suggestions {
    display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;
  }

  .suggestion-btn {
    padding: 8px 18px;
    border: 1px solid var(--border); background: transparent;
    color: var(--charcoal);
    font-family: 'Jost', sans-serif; font-size: 0.78rem;
    cursor: pointer; border-radius: 1px; transition: all 0.2s;
  }

  .suggestion-btn:hover, .suggestion-btn.active {
    background: var(--gold); border-color: var(--gold); color: white;
  }

  .amount-input-wrap { position: relative; margin-bottom: 20px; }

  .amount-currency {
    position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
    font-family: 'Cormorant Garamond', serif; font-size: 1.4rem; color: var(--gold);
  }

  .amount-input {
    width: 100%; padding: 14px 16px 14px 38px;
    border: 1px solid var(--border); border-radius: 1px;
    background: transparent;
    font-family: 'Cormorant Garamond', serif; font-size: 1.9rem;
    color: var(--charcoal); text-align: center; outline: none;
    transition: border-color 0.2s;
  }

  .amount-input:focus { border-color: var(--gold); }

  .confirm-btn {
    width: 100%; padding: 15px;
    background: var(--charcoal); color: var(--cream); border: none;
    font-family: 'Jost', sans-serif; font-size: 0.72rem;
    letter-spacing: 0.2em; text-transform: uppercase;
    cursor: pointer; border-radius: 1px; transition: background 0.3s;
  }

  .confirm-btn:hover { background: var(--gold-dark); }
  .confirm-btn:disabled { opacity: 0.6; cursor: not-allowed; }

  .iban-ornament { font-size: 2.8rem; margin-bottom: 14px; }

  .iban-box {
    background: var(--cream); border: 1px solid var(--border);
    border-radius: 2px; padding: 22px 24px; margin-bottom: 14px; text-align: left;
  }

  .iban-row { margin-bottom: 12px; }
  .iban-row:last-child { margin-bottom: 0; }

  .iban-label {
    font-size: 0.62rem; letter-spacing: 0.22em;
    text-transform: uppercase; color: var(--warm-gray); margin-bottom: 3px;
  }

  .iban-value {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.1rem; color: var(--charcoal); letter-spacing: 0.04em;
  }

  .copy-btn {
    width: 100%; padding: 11px;
    border: 1px solid var(--border); background: transparent; color: var(--warm-gray);
    font-family: 'Jost', sans-serif; font-size: 0.7rem;
    letter-spacing: 0.15em; text-transform: uppercase;
    cursor: pointer; border-radius: 1px; transition: all 0.2s; margin-bottom: 12px;
  }

  .copy-btn:hover { border-color: var(--gold); color: var(--gold-dark); }

  .iban-note {
    font-family: 'Cormorant Garamond', serif; font-style: italic;
    font-size: 0.88rem; color: var(--warm-gray); line-height: 1.6;
  }

  /* CONFETTI */
  .confetti-piece {
    position: fixed; top: -10px;
    animation: confetti-fall linear forwards;
    z-index: 200; pointer-events: none; border-radius: 1px;
  }

  @keyframes confetti-fall {
    0%   { transform: translateY(0) rotate(0deg); opacity: 1; }
    100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
  }

  @keyframes unlock-ring {
    0%   { box-shadow: 0 0 0 0 rgba(201,169,110,0.7); }
    100% { box-shadow: 0 0 0 32px rgba(201,169,110,0); }
  }

  .just-unlocked .milestone-circle { animation: unlock-ring 1s ease-out; }

  footer {
    text-align: center; padding: 36px 20px;
    border-top: 1px solid var(--border);
    position: relative; z-index: 1;
  }

  footer p {
    font-family: 'Cormorant Garamond', serif;
    font-style: italic; font-size: 0.95rem; color: var(--warm-gray);
  }

  @media (max-width: 600px) {
    header { padding: 36px 16px 22px; }
    .modal { padding: 34px 22px 28px; }
    .milestone-circle { width: 76px; height: 76px; }
    .milestone-emoji { font-size: 1.6rem; }
    .connector { width: 55px; }
    .milestone-label { width: 100px; }
  }
</style>
</head>
<body>

<div class="top-border"></div>

<header>
  <div class="header-ornament">‚ú¶ ‚ú¶ ‚ú¶</div>
  <h1>Marco <em>&</em> Sofia</h1>
  <div class="header-date">14 Giugno 2025 ¬∑ Roma</div>
  <div class="header-subtitle">
    Ogni dono accende una nuova tappa del nostro viaggio insieme.
  </div>
  <div class="sync-status">
    <div class="sync-dot loading" id="syncDot"></div>
    <span id="syncLabel">connessione in corso‚Ä¶</span>
  </div>
</header>

<div class="gift-btn-wrap">
  <button class="gift-btn" onclick="openGiftModal()" id="giftBtnMain">‚ú¶ Fai un regalo</button>
</div>

<div class="roadmap-outer" id="roadmapOuter">
  <div class="roadmap-inner" id="roadmap"></div>
</div>

<p class="scroll-hint">‚Üê scorri per scoprire il percorso ‚Üí</p>

<footer>
  <p>"Non √® il luogo che rende speciale il viaggio, ma chi lo condivide con te."</p>
</footer>

<!-- Gift modal -->
<div class="modal-overlay" id="giftModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('giftModal')">√ó</button>
    <div class="modal-title">Il tuo regalo</div>
    <div class="modal-sub">Scegli l'importo che desideri donare</div>
    <div class="amount-suggestions">
      <button class="suggestion-btn" onclick="setSuggestion(50)">‚Ç¨50</button>
      <button class="suggestion-btn" onclick="setSuggestion(100)">‚Ç¨100</button>
      <button class="suggestion-btn" onclick="setSuggestion(200)">‚Ç¨200</button>
      <button class="suggestion-btn" onclick="setSuggestion(500)">‚Ç¨500</button>
    </div>
    <div class="amount-input-wrap">
      <span class="amount-currency">‚Ç¨</span>
      <input type="number" class="amount-input" id="amountInput" placeholder="0" min="1"/>
    </div>
    <button class="confirm-btn" id="confirmBtn" onclick="confirmGift()">Conferma e scopri come donare ‚Üí</button>
  </div>
</div>

<!-- IBAN modal -->
<div class="modal-overlay" id="ibanModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('ibanModal')">√ó</button>
    <div class="iban-ornament">üíå</div>
    <div class="modal-title">Grazie di cuore</div>
    <div class="modal-sub">Il tuo gesto illumina un nuovo capitolo della nostra storia.</div>
    <div class="iban-box">
      <div class="iban-row">
        <div class="iban-label">Beneficiario</div>
        <div class="iban-value" id="ibanBeneficiario"></div>
      </div>
      <div class="iban-row">
        <div class="iban-label">IBAN</div>
        <div class="iban-value" id="ibanDisplay"></div>
      </div>
      <div class="iban-row">
        <div class="iban-label">Causale suggerita</div>
        <div class="iban-value" id="ibanCausale"></div>
      </div>
    </div>
    <button class="copy-btn" onclick="copyIBAN()">‚ßâ Copia IBAN</button>
    <div class="iban-note">Dopo il bonifico non √® necessario comunicarcelo ‚Äî terremo traccia con immensa gratitudine.</div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CONFIG = {
  beneficiario: 'Marco Rossi & Sofia Bianchi',
  iban: 'IT60 X054 2811 1010 0000 0123 456',
  causale: 'Lista Nozze Marco & Sofia',
};

const LEVELS = [
  { id: 1,  emoji: 'ü•Ç', name: 'Il Primo Brindisi',        desc: 'Una serata per festeggiare il primo anniversario',   amount: 50   },
  { id: 2,  emoji: 'üåπ', name: 'Petali di Rose',            desc: 'Un bouquet di rose rosse per ogni mese insieme',     amount: 120  },
  { id: 3,  emoji: 'üïØÔ∏è', name: 'Cena a Lume di Candela',   desc: 'Una cena romantica in un ristorante stellato',       amount: 220  },
  { id: 4,  emoji: 'üõÅ', name: 'Weekend di Relax',          desc: 'Una notte in una spa esclusiva',                     amount: 350  },
  { id: 5,  emoji: 'üåÖ', name: 'Alba sul Mare',             desc: 'Un fine settimana in un agriturismo costiero',       amount: 500  },
  { id: 6,  emoji: 'üöÇ', name: 'Viaggio in Treno',          desc: 'Il treno panoramico delle Dolomiti',                 amount: 700  },
  { id: 7,  emoji: 'üèõÔ∏è', name: 'Weekend a Parigi',          desc: 'Due giorni nella citt√† dell\'amore',                amount: 950  },
  { id: 8,  emoji: 'üåä', name: 'Crociera nel Mediterraneo', desc: 'Una settimana tra le isole greche',                  amount: 1300 },
  { id: 9,  emoji: 'üèîÔ∏è', name: 'Chalet sulle Alpi',         desc: 'Tre giorni in uno chalet di lusso',                 amount: 1700 },
  { id: 10, emoji: 'üå∏', name: 'Giappone in Fiore',         desc: 'I ciliegi in fiore di Kyoto in primavera',           amount: 2300 },
  { id: 11, emoji: 'üèùÔ∏è', name: 'Maldive',                   desc: 'Sette notti in un resort sull\'acqua',              amount: 3200 },
  { id: 12, emoji: '‚úàÔ∏è', name: 'Luna di Miele dei Sogni',   desc: 'Il grande viaggio ‚Äî avventura certa',                amount: 5000 },
];

// ‚îÄ‚îÄ FIREBASE INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyATAVj2MZuob6PWF5EfoEClS0gKNxNj4ZY",
  authDomain: "lista-nozze-8a00c.firebaseapp.com",
  databaseURL: "https://lista-nozze-8a00c-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "lista-nozze-8a00c",
  storageBucket: "lista-nozze-8a00c.firebasestorage.app",
  messagingSenderId: "65025205759",
  appId: "1:65025205759:web:00484ce9897ab18b87f3ca",
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);
const totalRef = ref(db, 'totale');

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentTotal = 0;

// ‚îÄ‚îÄ SYNC STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSync(state, text) {
  const dot   = document.getElementById('syncDot');
  const label = document.getElementById('syncLabel');
  dot.className = 'sync-dot ' + state;
  label.textContent = text;
}

// ‚îÄ‚îÄ LISTEN REALTIME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onValue(totalRef, (snapshot) => {
  const val = snapshot.val();
  const newTotal = val !== null ? parseFloat(val) : 0;

  const oldTotal = currentTotal;
  currentTotal = newTotal;

  setSync('online', 'sincronizzato');
  renderRoadmap();

  // Se qualcun altro ha appena sbloccato un livello, mostra i coriandoli
  const newlyUnlocked = LEVELS.filter(l => l.amount <= newTotal && l.amount > oldTotal);
  if (newlyUnlocked.length > 0 && oldTotal !== 0) {
    setTimeout(() => {
      newlyUnlocked.forEach(l => {
        const node = document.getElementById(`milestone-${l.id}`);
        if (node) node.classList.add('just-unlocked');
      });
      launchConfetti();
    }, 350);
  }
}, (error) => {
  setSync('error', 'errore di connessione');
  console.error(error);
});

// ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getStatus(idx) {
  if (currentTotal >= LEVELS[idx].amount) return 'unlocked';
  const prev = idx > 0 ? LEVELS[idx-1].amount : 0;
  if (currentTotal >= prev) return 'next';
  return 'locked';
}

function getPartialFill(idx) {
  const prev  = idx > 0 ? LEVELS[idx-1].amount : 0;
  const range = LEVELS[idx].amount - prev;
  return Math.min(100, Math.max(0, ((currentTotal - prev) / range) * 100));
}

// ‚îÄ‚îÄ RENDER ROADMAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRoadmap() {
  const container = document.getElementById('roadmap');
  container.innerHTML = '';

  const STEM_H   = 52;
  const LABEL_H  = 80;
  const CIRCLE_R = 48;

  LEVELS.forEach((level, idx) => {
    const status  = getStatus(idx);
    const isAbove = idx % 2 === 0;

    const node = document.createElement('div');
    node.className = `milestone ${status}`;
    node.id = `milestone-${level.id}`;
    node.style.cssText = 'display:flex;flex-direction:column;align-items:center;flex-shrink:0;';

    // LABEL
    const label = document.createElement('div');
    label.className = 'milestone-label';
    const nameEl = document.createElement('div');
    nameEl.className = 'milestone-name';
    nameEl.textContent = level.name;
    const descEl = document.createElement('div');
    descEl.className = 'milestone-desc';
    descEl.textContent = level.desc;
    label.appendChild(nameEl);
    label.appendChild(descEl);

    // STEM
    const stem = document.createElement('div');
    stem.className = 'milestone-stem';
    stem.style.height = STEM_H + 'px';

    // CIRCLE
    const circle = document.createElement('div');
    circle.className = 'milestone-circle';
    const emoji = document.createElement('span');
    emoji.className = 'milestone-emoji';
    emoji.textContent = status === 'locked' ? 'üîí' : level.emoji;
    const numEl = document.createElement('div');
    numEl.className = 'milestone-num';
    numEl.textContent = `Cap. ${level.id}`;
    const check = document.createElement('div');
    check.className = 'milestone-check';
    check.textContent = '‚úì';
    circle.appendChild(emoji);
    circle.appendChild(numEl);
    circle.appendChild(check);

    if (isAbove) {
      node.appendChild(label);
      node.appendChild(stem);
      node.appendChild(circle);
    } else {
      node.appendChild(circle);
      node.appendChild(stem);
      node.appendChild(label);
    }

    container.appendChild(node);

    // CONNECTOR
    if (idx < LEVELS.length - 1) {
      const nextIsAbove = (idx + 1) % 2 === 0;
      const curCircleTop  = isAbove     ? LABEL_H + STEM_H + CIRCLE_R : CIRCLE_R;
      const nextCircleTop = nextIsAbove ? LABEL_H + STEM_H + CIRCLE_R : CIRCLE_R;

      const connWrap = document.createElement('div');
      connWrap.style.cssText = `
        display:flex; flex-direction:column; align-items:center; flex-shrink:0;
        padding-top:${curCircleTop}px;
      `;

      const conn = document.createElement('div');
      conn.className = 'connector';
      if (status === 'unlocked') {
        conn.classList.add('done');
      } else if (status === 'next') {
        conn.classList.add('partial');
        conn.style.setProperty('--fill', getPartialFill(idx) + '%');
      }

      connWrap.appendChild(conn);
      container.appendChild(connWrap);
    }
  });

  // Scroll verso il nodo "next"
  setTimeout(() => {
    const nextNode = document.querySelector('.milestone.next');
    if (nextNode) {
      const outer = document.getElementById('roadmapOuter');
      outer.scrollTo({ left: nextNode.offsetLeft - outer.clientWidth / 2 + 48, behavior: 'smooth' });
    }
  }, 200);
}

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let totalBeforeGift = 0; // salviamo il totale prima del regalo per rilevare nuovi unlock

window.openGiftModal = function() {
  document.getElementById('amountInput').value = '';
  document.querySelectorAll('.suggestion-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('giftModal').classList.add('active');
};

window.closeModal = function(id) {
  document.getElementById(id).classList.remove('active');

  // Quando chiudo la modal IBAN, aggiorno la roadmap e mostro eventuali unlock
  if (id === 'ibanModal') {
    renderRoadmap();
    const newlyUnlocked = LEVELS.filter(l => l.amount <= currentTotal && l.amount > totalBeforeGift);
    if (newlyUnlocked.length > 0) {
      setTimeout(() => {
        newlyUnlocked.forEach(l => {
          const node = document.getElementById(`milestone-${l.id}`);
          if (node) node.classList.add('just-unlocked');
        });
        launchConfetti();
      }, 300);
    }
  }
};

window.setSuggestion = function(val) {
  document.getElementById('amountInput').value = val;
  document.querySelectorAll('.suggestion-btn').forEach(b =>
    b.classList.toggle('active', parseInt(b.textContent.replace('‚Ç¨','')) === val)
  );
};

window.confirmGift = async function() {
  const input  = document.getElementById('amountInput');
  const amount = parseFloat(input.value);
  if (!amount || amount <= 0) {
    input.style.borderColor = 'var(--rose)';
    setTimeout(() => input.style.borderColor = '', 700);
    return;
  }

  const btn = document.getElementById('confirmBtn');
  btn.disabled = true;
  btn.textContent = 'salvataggio‚Ä¶';
  setSync('loading', 'salvataggio in corso‚Ä¶');

  try {
    totalBeforeGift = currentTotal; // snapshot prima della transazione

    await runTransaction(totalRef, (current) => {
      return (current || 0) + amount;
    });

    // Aggiorna subito currentTotal localmente senza aspettare Firebase
    currentTotal = totalBeforeGift + amount;

    closeModal('giftModal');

    document.getElementById('ibanDisplay').textContent      = CONFIG.iban;
    document.getElementById('ibanBeneficiario').textContent = CONFIG.beneficiario;
    document.getElementById('ibanCausale').textContent      = CONFIG.causale;
    document.getElementById('ibanModal').classList.add('active');

  } catch(e) {
    setSync('error', 'errore salvataggio');
    alert('Errore nella connessione. Riprova tra un momento.');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Conferma e scopri come donare ‚Üí';
  }
};

window.copyIBAN = function() {
  navigator.clipboard.writeText(CONFIG.iban).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = '‚úì Copiato!';
    setTimeout(() => btn.textContent = '‚ßâ Copia IBAN', 2000);
  });
};

// ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function launchConfetti() {
  const colors = ['#c9a96e','#c4837a','#e8d5b0','#2c2825','#f7f2ea','#ffffff'];
  for (let i = 0; i < 70; i++) {
    setTimeout(() => {
      const p = document.createElement('div');
      p.className = 'confetti-piece';
      const size = 5 + Math.random() * 9;
      p.style.cssText = `
        left:${Math.random()*100}vw;
        background:${colors[Math.floor(Math.random()*colors.length)]};
        width:${size}px; height:${size}px;
        animation-duration:${1.8+Math.random()*2.2}s;
        animation-delay:${Math.random()*0.6}s;
        border-radius:${Math.random()>0.4?'50%':'1px'};
      `;
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 5000);
    }, i * 25);
  }
}

// ‚îÄ‚îÄ CLOSE ON OVERLAY CLICK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.modal-overlay').forEach(o =>
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); })
);

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setSync('loading', 'connessione in corso‚Ä¶');
renderRoadmap();
</script>
</body>
</html>
